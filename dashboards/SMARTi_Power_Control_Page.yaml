views:
  - title: Home
    cards:
      - type: custom:gap-card
      - type: custom:mushroom-title-card
        title: StrømFlyt™
        subtitle: Kontroller strømflyten i ditt hjem
      - type: custom:mod-card
        card_mod:
          style:
            .: |
              ha-card {
                --ha-card-border-width: 0.5px;
                --ha-card-border-radius: 20px;
              } 
            tabbed-card $:
              mwc-tab:
                $: |
                  .mdc-tab--active {
                    background: linear-gradient(to left, var(--accent-color), rgb(var(--rgb-primary-color-darker))) !important;
                    border-radius: 5px 5px 0px 0px;
                  }
                  mwc-tab:hover {
                    --mdc-theme-primary: red;
                    --mdc-tab-color-default: red;
                      }
                    
        card:
          type: custom:tabbed-card
          options:
            defaultTabIndex: null
          tabs:
            - attributes:
                label: Nettleie
                icon: mdi:finance
                isFadingIndicator: true
                isMinWidthIndicator: true
              card:
                type: vertical-stack
                cards:
                  - type: custom:mushroom-title-card
                    title: Nettleie
                    subtitle: Styr kun etter nettleie
                  - type: custom:apexcharts-card
                    graph_span: 1h
                    update_interval: 1s
                    header:
                      show: true
                      title: Forbruk (Siste time)
                      show_states: true
                      colorize_states: true
                    series:
                      - entity: sensor.dynamic_power_kw
                        name: Nåværende Forbruk
                        type: line
                        color: green
                        stroke_width: 2
                      - entity: input_number.energy_target
                        name: Kapasitetsmål (kWh)
                        type: line
                        color: var(--primary-color)
                        stroke_width: 2
                    yaxis:
                      - min: 0
                        decimals: 1
                    apex_config:
                      chart:
                        height: 300
                      plotOptions:
                        line:
                          curve: smooth
                      legend:
                        show: true
                  - type: custom:mushroom-number-card
                    entity: input_number.energy_target
                    name: Maksgrense per time (KW)
                    icon_color: accent
                  - type: vertical-stack
                    cards:
                      - type: custom:bar-card
                        title: Effektkontroll
                        entities:
                          - entity: sensor.controllable_power_percentage
                            name: Styrbar Effekt
                            color: green
                          - entity: sensor.non_controllable_power_percentage
                            name: Ikke-Styrbar Effekt
                            color: orange
                        max: 100
                        height: 30px
                  - type: horizontal-stack
                    cards:
                      - type: custom:gap-card
                      - type: custom:button-card
                        name: Legg Til Enhet
                        icon: mdi:folder-plus
                        tap_action:
                          action: fire-dom-event
                          browser_mod:
                            service: browser_mod.popup
                            data:
                              dismissable: true
                              title: Category 1 Devices (Always On)
                              content:
                                type: vertical-stack
                                cards:
                                  - type: entities
                                    entities:
                                      - entity: input_select.new_category_1_device
                                        name: Select Device to Add
                                  - type: custom:button-card
                                    name: Legg til enhet
                                    icon: mdi:plus-circle
                                    tap_action:
                                      action: call-service
                                      service: input_button.press
                                      service_data:
                                        entity_id: >-
                                          input_button.add_device_category_1_button
                                    styles:
                                      card:
                                        - background-color: green
                                        - color: white
                                        - height: 50px
                                        - display: flex
                                        - align-items: center
                                        - justify-content: center
                                      name:
                                        - font-size: 14px
                                        - font-weight: bold
                        styles:
                          card:
                            - height: 100px
                            - padding: 5px
                            - display: flex
                            - align-items: center
                            - justify-content: center
                          grid:
                            - grid-template-areas: '"i n"'
                            - grid-template-columns: 40px auto
                          icon:
                            - color: green
                            - width: 30px
                            - height: 30px
                          name:
                            - font-size: 14px
                            - font-weight: bold
                            - align-self: center
                      - type: custom:button-card
                        name: Slett Enhet
                        icon: mdi:delete
                        tap_action:
                          action: fire-dom-event
                          browser_mod:
                            service: browser_mod.popup
                            data:
                              dismissable: true
                              title: Delete Device from Category 1
                              content:
                                type: vertical-stack
                                cards:
                                  - type: entities
                                    entities:
                                      - entity: input_select.delete_category_1_device
                                        name: Select Device to Delete
                                  - type: custom:button-card
                                    name: Confirm Deletion
                                    icon: mdi:delete
                                    tap_action:
                                      action: call-service
                                      service: input_button.press
                                      service_data:
                                        entity_id: >-
                                          input_button.delete_category_1_device_button
                                    styles:
                                      card:
                                        - background-color: red
                                        - color: white
                                        - height: 50px
                                        - display: flex
                                        - align-items: center
                                        - justify-content: center
                                      name:
                                        - font-size: 14px
                                        - font-weight: bold
                              style: ''
                              '--popup-min-width': 400px;
                              '--popup-max-width': 600px;
                              '--popup-min-height': 800px;
                              '--popup-border-radius': 28px;
                        styles:
                          card:
                            - height: 100px
                            - padding: 5px
                            - display: flex
                            - align-items: center
                            - justify-content: center
                          grid:
                            - grid-template-areas: '"i n"'
                            - grid-template-columns: 40px auto
                          icon:
                            - color: red
                            - width: 30px
                            - height: 30px
                          name:
                            - font-size: 14px
                            - font-weight: bold
                            - align-self: center
                      - type: custom:gap-card
                  - type: horizontal-stack
                    cards:
                      - type: custom:auto-entities
                        card:
                          title: Devices in Category 1
                          type: custom:layout-card
                          layout_type: grid
                          card_param: cards
                        filter:
                          template: >
                            {% set entities_str = [
                              states('sensor.category_1_device_entities_part1'),
                              states('sensor.category_1_device_entities_part2'),
                              states('sensor.category_1_device_entities_part3'),
                              states('sensor.category_1_device_entities_part4')
                            ] | join(',') %} {% set exclude_entities = ['No
                            devices added', 'unknown', '', None] %} {% set
                            entity_ids = entities_str.split(',') | map('trim') |
                            reject('in', exclude_entities) | list %} {% set
                            entities = expand(entity_ids)
                              | rejectattr('state', 'equalto', 'unavailable')
                              | sort(attribute='attributes.friendly_name')
                              | map(attribute='entity_id')
                              | list %}
                            {{ entities }}
                        card_options:
                          type: custom:mushroom-entity-card
                          layout: horizontal
                          fill_container: true
                          primary_info: name
                          secondary_info: state
                        debug: true
                      - type: custom:auto-entities
                        card:
                          title: Category 1 Device Power Consumption
                          type: custom:layout-card
                          layout_type: grid
                          card_param: cards
                        filter:
                          template: >
                            {% set entities_str = [
                              states('sensor.category_1_device_power_entities_part1'),
                              states('sensor.category_1_device_power_entities_part2'),
                              states('sensor.category_1_device_power_entities_part3'),
                              states('sensor.category_1_device_power_entities_part4')
                            ] | join(',') %} {% set exclude_entities = ['No
                            power sensors available', 'unknown', '', None] %} {%
                            set entity_list = entities_str.split(',') |
                            map('trim') | list %} {% set entity_ids =
                            entity_list | reject('in', exclude_entities) | list
                            %} {% set entities = expand(entity_ids)
                              | rejectattr('state', 'equalto', 'unavailable')
                              | sort(attribute='attributes.friendly_name')
                              | map(attribute='entity_id')
                              | list %}
                            {{ entities }}
                        card_options:
                          type: custom:mushroom-entity-card
                          layout: horizontal
                          fill_container: true
                          primary_info: name
                          secondary_info: state
                        debug: true
                  - type: custom:auto-entities
                    card:
                      title: Category 1 Device Power Consumption
                      type: history-graph
                      hours_to_show: 24
                      refresh_interval: 60
                    filter:
                      template: >
                        {% set entities_str = [
                          states('sensor.category_1_device_power_entities_part1'),
                          states('sensor.category_1_device_power_entities_part2'),
                          states('sensor.category_1_device_power_entities_part3'),
                          states('sensor.category_1_device_power_entities_part4')
                        ] | join(',') %} {% set exclude_entities = ['No power
                        sensors available', 'unknown', '', None] %} {% set
                        entity_list = entities_str.split(',') | map('trim') |
                        list %} {% set entity_ids = entity_list | reject('in',
                        exclude_entities) | list %} {% set entities =
                        expand(entity_ids)
                          | rejectattr('state', 'equalto', 'unavailable')
                          | sort(attribute='attributes.friendly_name' or 'entity_id')
                          | map(attribute='entity_id')
                          | list %}
                        {{ entities }}
                    debug: true
            - attributes:
                label: Pris
                icon: mdi:currency-usd
                isFadingIndicator: true
                isMinWidthIndicator: true
              card:
                type: vertical-stack
                cards:
                  - type: vertical-stack
                    cards:
                      - type: custom:mushroom-title-card
                        title: Pris
                        subtitle: Styr kun etter pris
                      - type: custom:apexcharts-card
                        graph_span: 48h
                        header:
                          title: ''
                          show: true
                        span:
                          start: day
                        apex_config:
                          chart:
                            height: 390px
                        now:
                          show: true
                          label: Nå
                        experimental:
                          color_threshold: true
                        yaxis:
                          - id: pris
                            opposite: false
                            decimals: 2
                            min: 0
                            apex_config:
                              tickAmount: 5
                              labels:
                                show: true
                              legend:
                                - show: false
                          - id: powersaver
                            opposite: true
                            decimals: 0
                            min: 0
                            max: 1
                            apex_config:
                              tickAmount: 7
                              labels:
                                show: true
                              legend:
                                - show: true
                        series:
                          - entity: sensor.strompris_effektiv
                            name: Effektiv Strømpris
                            opacity: 1
                            float_precision: 2
                            extend_to: now
                            yaxis_id: pris
                            curve: smooth
                            color: red
                            stroke_width: 2
                            show:
                              legend_value: false
                              in_header: true
                              name_in_header: false
                              datalabels: false
                            data_generator: |

                              const data = entity.attributes.hours.map(hour => {

                                return [new Date(hour.start), hour.price];

                              });

                              if (data.length > 0) {

                                const lastDataPoint = data[data.length - 1];

                                const lastTime = new Date(lastDataPoint[0]);

                                const nextTime = new Date(lastTime.getTime() + 60 * 60 * 1000); // Legger til en time

                                data.push([nextTime, lastDataPoint[1]]); // Kopierer prisen fra siste datapunkt

                              }

                              return data;
                          - entity: sensor.strompris_nordpool
                            name: Nordpool
                            opacity: 1
                            float_precision: 2
                            extend_to: now
                            yaxis_id: pris
                            curve: smooth
                            color: 6B9EFF
                            stroke_width: 2
                            show:
                              legend_value: false
                              in_header: true
                              name_in_header: false
                              datalabels: false
                            data_generator: |

                              const data = entity.attributes.hours.map(hour => {

                                return [new Date(hour.start), hour.price];

                              });

                              if (data.length > 0) {

                                const lastDataPoint = data[data.length - 1];

                                const lastTime = new Date(lastDataPoint[0]);

                                const nextTime = new Date(lastTime.getTime() + 60 * 60 * 1000); // Legger til en time

                                data.push([nextTime, lastDataPoint[1]]); // Kopierer prisen fra siste datapunkt

                              }

                              return data;
                          - entity: sensor.strompris_stotte
                            name: Strømstøtte
                            opacity: 1
                            float_precision: 2
                            extend_to: now
                            yaxis_id: pris
                            curve: stepline
                            color: green
                            stroke_width: 1
                            show:
                              legend_value: false
                              in_header: true
                              name_in_header: false
                              datalabels: false
                            data_generator: |

                              const data = entity.attributes.hours.map(hour => {

                                return [new Date(hour.start), hour.price];

                              });

                              if (data.length > 0) {

                                const lastDataPoint = data[data.length - 1];

                                const lastTime = new Date(lastDataPoint[0]);

                                const nextTime = new Date(lastTime.getTime() + 60 * 60 * 1000); // Legger til en time

                                data.push([nextTime, lastDataPoint[1]]); // Kopierer prisen fra siste datapunkt

                              }

                              return data;
                          - entity: sensor.strompris_nettleie
                            name: Nettleie
                            opacity: 1
                            float_precision: 2
                            extend_to: now
                            yaxis_id: pris
                            curve: stepline
                            color: FF8800
                            stroke_width: 3
                            show:
                              legend_value: false
                              in_header: true
                              name_in_header: false
                              datalabels: false
                            data_generator: |

                              const data = entity.attributes.hours.map(hour => {

                                return [new Date(hour.start), hour.price];

                              });

                              if (data.length > 0) {

                                const lastDataPoint = data[data.length - 1];

                                const lastTime = new Date(lastDataPoint[0]);

                                const nextTime = new Date(lastTime.getTime() + 60 * 60 * 1000); // Legger til en time

                                data.push([nextTime, lastDataPoint[1]]); // Kopierer prisen fra siste datapunkt

                              }

                              return data;
                      - type: custom:apexcharts-card
                        header:
                          show: true
                          title: Pris i dag + Forbruk + Powersaver
                        now:
                          show: true
                          label: Nå
                        graph_span: 2d
                        span:
                          start: day
                        apex_config:
                          chart:
                            height: 400px
                          stroke:
                            width: 2
                          dataLabels:
                            enabled: true
                          fill:
                            type: gradient
                            gradient:
                              shadeIntensity: 1
                              inverseColors: true
                              opacityFrom: 0.8
                              opacityTo: 0.2
                          legend:
                            show: true
                          yaxis:
                            - id: price
                              show: true
                              min: 0
                              max: 2.5
                              tickAmount: 6
                              opposite: true
                              decimalsInFloat: 1
                              floating: false
                              forceNiceScale: true
                              extend_to: end
                            - id: usage
                              decimalsInFloat: 0
                              show: true
                              min: 0
                              forceNiceScale: true
                            - id: powersaver
                              show: false
                              decimalsInFloat: 0
                              floating: false
                              extend_to: now
                        series:
                          - entity: sensor.strompris_effektiv
                            yaxis_id: price
                            extend_to: now
                            name: Faktisk strømpris
                            type: area
                            curve: stepline
                            color: tomato
                            float_precision: 2
                            show:
                              legend_value: false
                            data_generator: |
                              return entity.attributes.hours.map((entry) => {
                                return [new Date(entry.start), entry.price];
                              });
                          - entity: sensor.dynamic_power_sensor
                            yaxis_id: usage
                            type: column
                            name: Forbruk
                            time_delta: +30m
                            group_by:
                              func: max
                            show:
                              legend_value: true
                          - entity: sensor.powersaver_payload
                            data_generator: |

                              return entity.attributes.hours.map((entry) => {

                                return [new Date(entry.start), entry.onOff];

                              });
                            yaxis_id: powersaver
                            name: Power Saver
                            type: area
                            color: rgb(0, 255, 0)
                            opacity: 0.1
                            stroke_width: 1
                            curve: stepline
                            group_by:
                              func: max
                            show:
                              legend_value: false
                              in_header: false
                              name_in_header: false
                              datalabels: false
            - attributes:
                label: NettLeie + Pris
                icon: mdi:chart-timeline-variant-shimmer
                isFadingIndicator: true
                isMinWidthIndicator: true
              card:
                type: vertical-stack
                cards:
                  - type: custom:config-template-card
                    entities:
                      - zone.home
                    card:
                      type: iframe
                      url: >-
                        ${'https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=default&metricTemp=default&metricWind=default&zoom=9&overlay=wind&product=ecmwf&level=surface&lat='
                        + states['zone.home'].attributes.latitude + '&lon=' +
                        states['zone.home'].attributes.longitude + '&detailLat='
                        + states['zone.home'].attributes.latitude +
                        '&detailLon=' + states['zone.home'].attributes.longitude
                        + '&marker=true'}
                      aspect_ratio: 50%
                  - type: custom:weather-radar-card
                    card_title: Regnradar
                    map_style: Dark
                    zoom_level: 10
                    show_marker: true
                    show_scale: false
                    show_zoom: true
                    show_range: false
                    show_playback: false
      - type: entities
        entities:
          - entity: input_select.price_zone
            name: Price Zone
          - entity: input_boolean.include_vat
            name: Include VAT
          - entity: sensor.adjusted_electricity_price
            name: Adjusted Electricity Price
          - entity: sensor.grid_tariff
            name: Grid Tariff
          - entity: sensor.government_support
            name: Government Support
          - entity: sensor.effective_electricity_price
            name: Effective Electricity Price
          - entity: sensor.current_hour_price
            name: Current Hour Price
          - entity: sensor.power_saver_status
            name: Power Saver Status
    badges:
      - type: custom:button-card
        name: Update Device Options
        icon: mdi:refresh
        color_type: icon
        show_name: true
        show_icon: true
        tap_action:
          action: call-service
          service: automation.trigger
          service_data:
            entity_id: automation.populate_category_device_options
        styles:
          card:
            - border-radius: 15px
            - box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.3)
          icon:
            - color: var(--primary-color)
          name:
            - font-weight: bold
            - font-size: 16px
            - color: var(--text-color)
    type: custom:horizontal-layout
    layout:
      max_width: 2000
      max_cols: 1
  - title: Electricity Prices Dashboard
    cards:
      - type: entities
        title: Electricity Price Controls
        entities:
          - entity: input_select.price_zone
            name: Price Zone
          - entity: input_boolean.include_vat
            name: Include VAT
      - type: custom:apexcharts-card
        graph_span: 48h
        header:
          title: Electricity Prices
          show: true
        span:
          start: day
        apex_config:
          chart:
            height: 390px
        now:
          show: true
          label: Now
        experimental:
          color_threshold: true
        yaxis:
          - id: price
            opposite: false
            decimals: 2
            min: 0
            apex_config:
              tickAmount: 5
              labels:
                show: true
              legend:
                show: false
          - id: powersaver
            opposite: true
            decimals: 0
            min: 0
            max: 1
            apex_config:
              tickAmount: 7
              labels:
                show: true
              legend:
                show: true
        series:
          - entity: sensor.effective_electricity_price
            name: Effective Electricity Price
            opacity: 1
            float_precision: 2
            extend_to: now
            yaxis_id: price
            curve: smooth
            color: red
            stroke_width: 2
            show:
              legend_value: false
              in_header: true
              name_in_header: false
              datalabels: false
            data_generator: |
              const data = entity.attributes.hours.map(hour => {
                return [new Date(hour.start), hour.price];
              });
              return data;
          - entity: sensor.nordpool_price
            name: Nordpool Price
            opacity: 1
            float_precision: 2
            extend_to: now
            yaxis_id: price
            curve: smooth
            color: '#6B9EFF'
            stroke_width: 2
            show:
              legend_value: false
              in_header: true
              name_in_header: false
              datalabels: false
            data_generator: |
              const data = entity.attributes.hours.map(hour => {
                return [new Date(hour.start), hour.price];
              });
              return data;
          - entity: sensor.government_support
            name: Government Support
            opacity: 1
            float_precision: 2
            extend_to: now
            yaxis_id: price
            curve: stepline
            color: green
            stroke_width: 1
            show:
              legend_value: false
              in_header: true
              name_in_header: false
              datalabels: false
            data_generator: |
              const data = entity.attributes.hours.map(hour => {
                return [new Date(hour.start), hour.price];
              });
              return data;
          - entity: sensor.grid_tariff
            name: Grid Tariff
            opacity: 1
            float_precision: 2
            extend_to: now
            yaxis_id: price
            curve: stepline
            color: '#FF8800'
            stroke_width: 3
            show:
              legend_value: false
              in_header: true
              name_in_header: false
              datalabels: false
            data_generator: |
              const data = entity.attributes.hours.map(hour => {
                return [new Date(hour.start), hour.price];
              });
              return data;
      - type: custom:apexcharts-card
        header:
          show: true
          title: Pris i dag + Forbruk + Powersaver
        now:
          show: true
          label: Nå
        graph_span: 2d
        span:
          start: day
        apex_config:
          chart:
            height: 400px
          stroke:
            width: 2
          dataLabels:
            enabled: true
          fill:
            type: gradient
            gradient:
              shadeIntensity: 1
              inverseColors: true
              opacityFrom: 0.8
              opacityTo: 0.2
          legend:
            show: true
          yaxis:
            - id: price
              show: true
              min: 0
              max: 2.5
              tickAmount: 6
              opposite: true
              decimalsInFloat: 1
              floating: false
              forceNiceScale: true
              extend_to: end
            - id: usage
              decimalsInFloat: 0
              show: true
              min: 0
              forceNiceScale: true
            - id: powersaver
              show: false
              decimalsInFloat: 0
              floating: false
              extend_to: now
        series:
          - entity: sensor.effective_electricity_price
            yaxis_id: price
            extend_to: now
            name: Faktisk strømpris
            type: area
            curve: stepline
            color: tomato
            float_precision: 2
            show:
              legend_value: false
            data_generator: |
              return entity.attributes.hours.map((entry) => {
                return [new Date(entry.start), entry.price];
              });
          - entity: sensor.dynamic_power_sensor
            yaxis_id: usage
            type: column
            name: Forbruk
            time_delta: +30m
            group_by:
              func: max
            show:
              legend_value: true
          - entity: sensor.power_saver_payload
            data_generator: |
              return entity.attributes.hours.map((entry) => {
                return [new Date(entry.start), entry.onOff];
              });
            yaxis_id: powersaver
            name: Power Saver
            type: area
            color: rgb(0, 255, 0)
            opacity: 0.1
            stroke_width: 1
            curve: stepline
            group_by:
              func: max
            show:
              legend_value: false
              in_header: false
              name_in_header: false
              datalabels: false
    layout:
      max_width: 2000
      max_cols: 1
    type: custom:horizontal-layout
